<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rede Privada Firebase</title>

<style>
body{
    margin:0;
    font-family:Arial, sans-serif;
    background:linear-gradient(135deg,#141e30,#243b55);
    color:white;
}
.hidden{display:none;}
.container{
    width:90%;
    max-width:400px;
    margin:40px auto;
    background:#1c1c1c;
    padding:25px;
    border-radius:12px;
}
input{
    width:100%;
    padding:10px;
    margin:8px 0;
    border:none;
    border-radius:6px;
}
button{
    padding:10px;
    border:none;
    border-radius:6px;
    background:#00ffcc;
    font-weight:bold;
    cursor:pointer;
}
.menu{
    padding:15px;
    background:#000;
    display:flex;
    align-items:center;
    gap:10px;
}
.menu img{
    width:45px;
    height:45px;
    border-radius:50%;
    object-fit:cover;
}
.feed{
    padding:15px;
    max-width:600px;
    margin:auto;
}
.post{
    background:#1c1c1c;
    padding:15px;
    border-radius:12px;
    margin-bottom:20px;
}
.post img,.post video{
    width:100%;
    border-radius:10px;
    margin-top:10px;
}
.chat-box{
    background:#111;
    border-radius:12px;
    padding:10px;
    margin-top:10px;
    max-height:300px;
    display:flex;
    flex-direction:column;
}
.chat-mensagens{
    flex:1;
    overflow-y:auto;
    margin-bottom:10px;
    font-size:14px;
}
.chat-msg{
    margin-bottom:6px;
    padding:6px;
    background:#1c1c1c;
    border-radius:6px;
}
</style>
</head>
<body>

<!-- REGISTRO -->
<div class="container" id="registerBox">
<h2>Criar Conta</h2>
<input type="text" id="regNome" placeholder="Seu nome">
<input type="file" id="regFoto" accept="image/*">
<input type="text" id="regKey" placeholder="Crie sua Key">
<button onclick="registrar()">Registrar</button>
<p>Já tem conta? 
<span onclick="mostrarLogin()" style="color:#00ffcc;cursor:pointer;">Entrar</span>
</p>
</div>

<!-- LOGIN -->
<div class="container hidden" id="loginBox">
<h2>Login</h2>
<input type="text" id="loginKey" placeholder="Digite sua Key">
<button onclick="login()">Entrar</button>
</div>

<!-- AREA PRIVADA -->
<div class="hidden" id="privado">

<div class="menu">
<img id="perfilFoto">
<div id="perfilNome"></div>
<button style="margin-left:auto;background:red;color:white;" onclick="logout()">Sair</button>
</div>

<div class="feed">

<h3>Nova Publicação</h3>
<input type="file" id="fileInput" accept="image/*,video/*">
<button onclick="postar()">Postar</button>
<hr>

<div id="posts"></div>

<h3>Chat da Sala</h3>
<div class="chat-box">
<div class="chat-mensagens" id="chatBox"></div>
<input type="text" id="chatInput" placeholder="Digite mensagem">
<button onclick="enviarMensagem()">Enviar</button>
</div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
getFirestore, doc, setDoc, getDoc,
collection, addDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "COLE_AQUI",
  authDomain: "COLE_AQUI",
  projectId: "COLE_AQUI",
  storageBucket: "COLE_AQUI",
  messagingSenderId: "COLE_AQUI",
  appId: "COLE_AQUI"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let usuarioLogado = null;
let salaAtual = null;

window.mostrarLogin = function(){
registerBox.classList.add("hidden");
loginBox.classList.remove("hidden");
}

// REGISTRAR
window.registrar = async function(){
let nome = regNome.value.trim();
let key = regKey.value.trim();
let foto = regFoto.files[0];

if(!nome || !key || !foto){
alert("Preencha tudo");
return;
}

let userRef = doc(db,"usuarios",key);
let snap = await getDoc(userRef);

if(snap.exists()){
alert("Key já existe");
return;
}

let reader = new FileReader();
reader.onload = async function(e){
await setDoc(userRef,{
nome:nome,
foto:e.target.result
});
alert("Conta criada!");
mostrarLogin();
}
reader.readAsDataURL(foto);
}

// LOGIN
window.login = async function(){
let key = loginKey.value.trim();
let userRef = doc(db,"usuarios",key);
let snap = await getDoc(userRef);

if(!snap.exists()){
alert("Key inválida");
return;
}

usuarioLogado = snap.data();
salaAtual = key;

perfilNome.innerHTML = usuarioLogado.nome;
perfilFoto.src = usuarioLogado.foto;

loginBox.classList.add("hidden");
registerBox.classList.add("hidden");
privado.classList.remove("hidden");

carregarPosts();
carregarChat();
}

// POSTAR
window.postar = async function(){
let file = fileInput.files[0];
if(!file) return alert("Escolha um arquivo");

let reader = new FileReader();
reader.onload = async function(e){
await addDoc(collection(db,"salas",salaAtual,"posts"),{
tipo: file.type.startsWith("image") ? "img":"video",
src: e.target.result
});
}
reader.readAsDataURL(file);
}

// CARREGAR POSTS
function carregarPosts(){
onSnapshot(collection(db,"salas",salaAtual,"posts"),snapshot=>{
posts.innerHTML="";
snapshot.forEach(docSnap=>{
let p = docSnap.data();
let div=document.createElement("div");
div.className="post";

if(p.tipo==="img"){
let img=document.createElement("img");
img.src=p.src;
div.appendChild(img);
}else{
let video=document.createElement("video");
video.src=p.src;
video.controls=true;
div.appendChild(video);
}

posts.appendChild(div);
});
});
}

// CHAT
window.enviarMensagem = async function(){
let texto = chatInput.value.trim();
if(!texto) return;

await addDoc(collection(db,"salas",salaAtual,"chat"),{
nome:usuarioLogado.nome,
texto:texto
});
chatInput.value="";
}

function carregarChat(){
onSnapshot(collection(db,"salas",salaAtual,"chat"),snapshot=>{
chatBox.innerHTML="";
snapshot.forEach(docSnap=>{
let msg=docSnap.data();
let div=document.createElement("div");
div.className="chat-msg";
div.innerHTML="<b>"+msg.nome+":</b> "+msg.texto;
chatBox.appendChild(div);
});
chatBox.scrollTop=chatBox.scrollHeight;
});
}

window.logout = function(){
usuarioLogado=null;
privado.classList.add("hidden");
loginBox.classList.remove("hidden");
}

</script>

</body>
</html>
