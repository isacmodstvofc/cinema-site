<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rede por Key</title>

<style>
body{
margin:0;
font-family:Arial;
background:linear-gradient(135deg,#141e30,#243b55);
color:white;
}
.hidden{display:none;}
.container{
width:90%;
max-width:400px;
margin:40px auto;
background:#1c1c1c;
padding:25px;
border-radius:12px;
}
input,button{
width:100%;
padding:10px;
margin:8px 0;
border:none;
border-radius:6px;
}
button{
background:#00ffcc;
font-weight:bold;
cursor:pointer;
}
.feed{
max-width:600px;
margin:auto;
padding:15px;
}
.post{
background:#1c1c1c;
padding:15px;
border-radius:12px;
margin-bottom:15px;
}
.post img,.post video,iframe{
width:100%;
border-radius:10px;
margin-top:10px;
}
.chat{
background:#111;
padding:10px;
border-radius:12px;
max-height:300px;
display:flex;
flex-direction:column;
}
.chat-msg{
background:#1c1c1c;
padding:6px;
border-radius:6px;
margin-bottom:6px;
}
</style>
</head>
<body>

<!-- REGISTRO -->
<div class="container" id="registerBox">
<h2>Criar Conta</h2>
<input type="email" id="regEmail" placeholder="Email">
<input type="password" id="regSenha" placeholder="Senha">
<input type="text" id="regKey" placeholder="Criar Key da Sala">
<button onclick="registrar()">Criar Conta</button>
<p onclick="mostrarLogin()" style="color:#00ffcc;cursor:pointer;">
Já tenho conta
</p>
</div>

<!-- LOGIN POR KEY -->
<div class="container hidden" id="loginBox">
<h2>Entrar na Sala</h2>
<input type="text" id="loginKey" placeholder="Digite a Key">
<button onclick="entrarSala()">Entrar</button>
</div>

<!-- SALA -->
<div class="hidden" id="sala">

<div class="feed">

<h3>Nova Publicação</h3>
<input type="file" id="fileInput" accept="image/*,video/*">
<input type="text" id="linkInput" placeholder="Ou cole link do vídeo">
<button onclick="postar()">Postar</button>
<hr>

<div id="posts"></div>

<h3>Bate-papo</h3>
<div class="chat">
<div id="chatBox" style="flex:1;overflow-y:auto;"></div>
<input type="text" id="chatInput" placeholder="Mensagem">
<button onclick="enviarMensagem()">Enviar</button>
</div>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
getFirestore, doc, setDoc, getDoc,
collection, addDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
apiKey:"COLE_AQUI",
authDomain:"COLE_AQUI",
projectId:"COLE_AQUI",
storageBucket:"COLE_AQUI",
messagingSenderId:"COLE_AQUI",
appId:"COLE_AQUI"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let salaAtual=null;

// MOSTRAR LOGIN
window.mostrarLogin=function(){
registerBox.classList.add("hidden");
loginBox.classList.remove("hidden");
}

// REGISTRAR
window.registrar=async function(){

let email=regEmail.value.trim();
let senha=regSenha.value.trim();
let key=regKey.value.trim();

if(!email||!senha||!key) return alert("Preencha tudo");

let salaRef=doc(db,"salas",key);
let salaSnap=await getDoc(salaRef);

if(salaSnap.exists()) return alert("Key já existe");

await createUserWithEmailAndPassword(auth,email,senha);

await setDoc(salaRef,{
key:key,
criadoEm:new Date()
});

alert("Conta criada com sucesso!");
mostrarLogin();
}

// ENTRAR SALA POR KEY
window.entrarSala=async function(){

let key=loginKey.value.trim();
if(!key) return;

let salaRef=doc(db,"salas",key);
let salaSnap=await getDoc(salaRef);

if(!salaSnap.exists()) return alert("Sala não existe");

salaAtual=key;

loginBox.classList.add("hidden");
sala.classList.remove("hidden");

carregarPosts();
carregarChat();
}

// POSTAR
window.postar=async function(){

let file=fileInput.files[0];
let link=linkInput.value.trim();

if(!file && !link) return alert("Escolha algo");

if(file){
let reader=new FileReader();
reader.onload=async function(e){
await addDoc(collection(db,"salas",salaAtual,"posts"),{
tipo:file.type.startsWith("image")?"img":"video",
src:e.target.result
});
}
reader.readAsDataURL(file);
}

if(link){
await addDoc(collection(db,"salas",salaAtual,"posts"),{
tipo:"link",
src:link
});
}

fileInput.value="";
linkInput.value="";
}

// CARREGAR POSTS
function carregarPosts(){
onSnapshot(collection(db,"salas",salaAtual,"posts"),snap=>{
posts.innerHTML="";
snap.forEach(docSnap=>{
let p=docSnap.data();
let div=document.createElement("div");
div.className="post";

if(p.tipo==="img"){
let img=document.createElement("img");
img.src=p.src;
div.appendChild(img);
}
if(p.tipo==="video"){
let video=document.createElement("video");
video.src=p.src;
video.controls=true;
div.appendChild(video);
}
if(p.tipo==="link"){
let iframe=document.createElement("iframe");
iframe.src=p.src;
iframe.height="300";
div.appendChild(iframe);
}
posts.appendChild(div);
});
});
}

// CHAT
window.enviarMensagem=async function(){
let texto=chatInput.value.trim();
if(!texto) return;

await addDoc(collection(db,"salas",salaAtual,"chat"),{
texto:texto
});
chatInput.value="";
}

function carregarChat(){
onSnapshot(collection(db,"salas",salaAtual,"chat"),snap=>{
chatBox.innerHTML="";
snap.forEach(docSnap=>{
let msg=docSnap.data();
let div=document.createElement("div");
div.className="chat-msg";
div.innerText=msg.texto;
chatBox.appendChild(div);
});
});
}

</script>
</body>
</html>
